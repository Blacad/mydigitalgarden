---
{"dg-publish":true,"permalink":"/my-c-nnotes/lecture/lecture-3/","dgPassFrontmatter":true}
---


# 提要
---
- 本章节很重要
- 掌握页标红的都需要熟练掌握，其余了解
# 1 网络层服务
---
- 提供给传输层的服务
	- 无连接 --- 数据报，主流方式
	- 面向连接 --- 虚电路
	- 💡虚电路和数据报对比![Pasted image 20241123143456.png](/img/user/MyCNnotes/assets/Pasted%20image%2020241123143456.png)

# 2 Internet 网际协议
---
## 2.1 IPv4
---
- 概述
	- 寻址与分片

- 数据报格式

- 数据报分片
	- IPv4头部有20Bytes，每个分片也有20Bytes的头
	- MTU
		- path MTU = min{MTUs in the path}
	- 分片策略
	- 重组策略
	- DF=0 MF=1 for not the last one；0 for the last one ==片偏移单位是8bytes==
	- 注意，==非最后分片的有效数据的最大长度如果不是8的倍数，则要取小于该最大长度的最大8的倍数作为有效数据的长度，这样才能算出正确的偏移量==。对最后一个分片无所谓，只要放下剩余数据即可。有效数据的最大长度=path MTU - 20Bytes![Pasted image 20241107111619.png](/img/user/MyCNnotes/assets/Pasted%20image%2020241107111619.png)

 - IP地址
	 - 32位标识符
	 - ip 地址分成四部分，每部分占8bits最大数是255，一般都是用十进制表示
	 - 网络号和主机号
	 - ip特殊地址
  
 - 子网划分
	 - 子网掩码
	 - 💡CIDR --- 指定网络前缀的位数
		 - PPT上的思考题解答![Pasted image 20241031150510.png](/img/user/MyCNnotes/assets/Pasted%20image%2020241031150510.png)
		- 最长前缀匹配
			-  IP地址与IP前缀匹配时，总是选取子网掩码最长的匹配项
	- 分类IP地址 --- CIDR之前

- IPv4地址获取

## 2.2 DHCP动态主机配置协议
---
- C/S 模式，基于UDP，67 port S，68 port C
- 💡工作流程 --- any-cast

## 2.3 ARP
---
- IP 与 MAC 地址 --- MAC的始末地址是一跳的，因此在改变，而IP的始末地址是始末主机的地址，因此传输过程不变
- ARP地址解析 - 利用目标的 IP地址 得到MAC地址
	- 工作过程

- IP 包转发
	- 同子网 --- 直接交付
	- 路由到另一个局域网

## 2.4 NAT
---
- 网络地址转换 NAT 用于解决IPv4地址不足的问题，将私有地址 转化为 公有 IP 地址的转换技术
- 两个内网间的 IP 地址可以重复
- 一个内网指定一个出口地址，互联网是不能找到内网地址的，因此设置该出口地址用于内网与互联网通信，而内网内部的地址可以设置很多个，只要保证自己内部不重复即可
- 出口地址的路由器通过端口指定对应内部主机端口[NAT转换的格式是 <ip,port> 两者只要变了一个就需要用新的对应项]


- Skype relay 通过一个中继器实现访问内网

## 2.5 ICMP
---
- 互联网控制报文协议ICMP，允许主机或路由器报告差错情况和提供有关异常情况的报告
- PING 命令 和 tracert 命令 是基于 ICMP 的

- 有个思考题

# 3 路由算法
---
## 3.1 优化原则与最短路径算法
---
- 汇聚树 Sink Tree 所有的源节点到一个指定目标节点的最优路径的集合构成一棵以目标节点为根的树
- 汇集树不是唯一的
- 最短路径算法 --- Dijkstra --- 全局算法
## 3.2 距离向量路由 --- DV
---
- Bellman-Ford 方程
	- 方程逻辑
		- 遍历自己所有邻居结点
		- 找到 自己到邻居距离+邻居结点到目标结点的最短距离 的最小值 作为自己到目标结点的最短距离
		- 循环往复，生成自己的路由向量
 - 距离向量：到网络中所有结点(包括自己)的最短距离组成的向量，即 Bellman-Ford 方程的 $D_{x}(y)$ 是x 到 y的最短距离，也就是 距离向量的一个元素
 - `说明：距离向量初始化时，仅初始化 到自己的值0 和 到邻居结点的直接链路值。对于B-F方程，由于接收邻居包时有顺序之分而我们只是要最小值，所以我们的更新逻辑是 如果由发来的包计算得到的最短距离小于我们的记录则更新；否则不管`（传播同步问题）
 - 距离向量路由算法逻辑
	 - 每个结点先完成自己的初始化
	 - 每个结点周期性地向邻居发送它自己到某些节点的距离向量
	 - 当节点x接收到来自邻居的新DV估计，它使用B-F方程更新其自己的DV
	 - `说明：当链路更新时，则直接改变链路两端结点的DV表关于该链路的信息`
 - 迭代的、分布式的
 - 坏消息 --- 链路费用增加或者结点下线 可能导致 Count-to-infinity
	 - Poisoned reverse 毒性逆转，如果C通过B得到到达A的最短距离，那么C告诉B自己到A的距离无穷大 --- 没完全解决

## 3.3 链路状态路由 --- LS
---
- 过程
	1.  发现邻居，知道它们的地址
	2. 设置到每个邻居的成本
	3. 构造结点到它所有邻居的分组数据包
	4. 每个结点将自己的分组数据包分发给所有路由
	5. Dijkstra 计算得到最短路径
	- 最终每个路由器都得到整张网络的拓扑，最后用 Dijkstra 算出即可

## 3.4 层次路由
---
- 基本思想使同接口地址聚合
- AS 自治系统
	- AS ID 全球唯一
	- 每个AS内部协议一致，不同AS的内部协议可以不同
	- AS 下还可以分为私有AS 和 区域
- AS 内部网关路由协议 IGP(Interior Gateway Protocols), AS之间外部网关路由协议 EGP（Exterior Gateway Protocols）
	- IGP --- OSPF，RIP，IS-IS，IGRP，EIGRP……
	- EGP --- BGP
## 3.5 广播路由
---
- 方法三：泛洪 flooding
	- 受控制的泛洪
		- 序号控制泛洪 --- 需要序号表
		- 逆向路径转发 RPF --- 复用路由表 
- 方法四：生成树

## 3.6 组播路由
---
- IGMP --- 获得网段的组播组成员
- 组播实现
	- 生成树 --- 路由器之间
		- 密集 --- 源点树
		- 稀疏 --- 核心树
## 3.7 选播路由
---
- 选播（Anycast）将数据包传送给最近的一个组成员
- 典型应用 DNS
# 4 Internet 路由协议
---
- AS 内部网关路由协议 IGP(Interior Gateway Protocols), AS之间外部网关路由协议 EGP
## 4.1 OSPF
---
- OSPF（Open Shortest Path First）开放最短路径优先协议，使用 LS，用在 AS 内
- 区域
	- 主干区域
	- 非主干区域
	- IR、ABR、ASBR

## 4.2 RIP
---
- 路由选择协议RIP（ Routing Information Protocol），使用 DV，用在 AS 内
- ==使用跳数衡量到达目的网络的距离==，只根据跳数来决定，OSPF需要综合考虑带宽等
- 路由器交换的内容是自己的路由表(事实上是DV和路由表的综合，包含目标网络、最短距离和下一跳)

## 4.3 BGP
---
- 边界网关协议BGP 目前互联网中唯一实际运行的自治域间的路由协议，用在 AS 之间
- eBGP 和 iBGP
- BGP会话: 两个BGP路由器通过TCP连接交换BGP报文
- 类似于 DV，但是不同于DV的是它的广播包需要包含到目标网段的完整的路径[将AS想象成不同国家的网络，那么出于国家安全的考虑需要在意完整的路径]
- 有决定路由的策略

## 4.4 MPLS
---
- MPLS (MultiProtocol Label Switching)全称是多协议标签交换
- 标签是指每个分组被分配一个标签，路由器根据该标签对分组进行转发
- 交换是指标签的交换，MPLS 报文交换和转发是基于标签的
- LSR、MPLS、LDP
- 运行在 IP 之下
- 相比于 路由表 它还添加了 入口标签 和 出口标签的对应 即 由 <入口接口，出口接口> 变为 <入口接口，入口标签，出口接口，出口标签>

# 5 路由器工作原理
---
- 路由器是互联网最主要的网络设备，包含2个核心功能
	- 控制层 ：运行各种路由协议：BGP、OSPF、RIP，学习去往不同目的的转发路径：路由表
	- 数据层：根据上述路由表，将收到的IP分组转发到正确的下一跳链路 ：转发表FIB

# 拥塞控制算法
---
- 拥塞：网络中存在太多的数据包导致数据包传输延迟或丢失，从而导致网络吞吐量下降
- 开环控制 --- 事先对通信流参数进行协商，协商后，不管网络是拥塞还是带宽充足，参数不能动态改变
- 闭环控制 --- 根据网络状态进行动态控制，包括两部分：反馈机制和控制机制。
- 抑制包 --- 用于通知发送方减小发送量
# 服务质量
---
- QoS
- 流量整形 --- 其作用是限制流出某一网络的某一连接的流量与突发，使这类报文以比较均匀的速度向外发送
	- 漏桶算法（Leaky Bucket Algorithm）：主要目的是控制数据注入到网络的速率，平滑网络上的突发流量。漏桶算法提供了一种控制机制，通过它，突发流量可以被整形以便为网络提供一个稳定的流量
	- 令牌桶算法（Token Bucket Algorithm）：用来控制发送到网络上的数据的数目，并允许突发数据的发送。初始容量 B、token 速率 R，突发速率 M 突发时长 S，则 B+RS = MS
	- 详细内容可以参见 中文教材的流量整形部分
- 数据报调度
- 综合服务 和 区分服务
- 区分服务的一种做法
	- 在网络内部，路由器针对每条出境线路可以有两个输出队列，一个用于加速数据包，另一个用于常规数据包。当一个包到达时，它被排入相应的队列。加速队列获得的优先级要高于常规队列，例如，使用优先级数据包调度算法。通过这种方式，加速数据包看到的是一个没有负载的网络，即使事实上普通流量的负载很重

# 三层交换与VPN
---
- VPN 原则：安全性、隧道与加密、数据验证、用户验证、防火墙与攻击检测
- VPN指利用公用网络架设专用网络的远程访问技术，通过隧道技术在公共网络上模拟出一条点到点的逻辑专线，从而达到安全数据传输的目的

# IPv6技术
---
- 初始动机：应付“32-bit地址空间耗尽”问题（CIDR和NAT都无法从根本上解决地址短缺问题），增加地址空间
- 地址长度为128bit，是IPv4地址长度的4倍，地址空间数量约为3\*10^38
- IPv6地址表示法，冒分十六进制，x:x:x:x:x:x:x:x，每个 x 有 4 个 16进制数
	- 简化方法：每个x前面的0可省略，可把连续的值为0的x表示为“::” , 且“::”只能出现1次,确保简化后的可逆性
	- 简化前地址，2001:0DA8:0000:0000:200C:0000:0000:00A5
	- 简化后地址，2001:DA8:0000:0000:200C::A5
- IPv6分片机制
	- IPv6分组不能在传输途中分片，只在源端进行分片

- 主流过渡技术
	- 双栈技术 --- IPv4 和 IPv6 都有，互相翻译
	- 隧道技术
	- 翻译技术